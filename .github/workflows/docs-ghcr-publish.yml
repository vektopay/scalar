name: Publish Docs Image to GHCR

on:
  push:
    branches:
      - master
    paths:
      - 'integrations/docker/**'
      - 'packages/api-reference/**'
      - '.github/actions/build/**'
      - '.github/actions/setup-node/**'
      - '.github/workflows/docs-ghcr-publish.yml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'turbo.json'
  workflow_dispatch: null

concurrency:
  group: docs-ghcr-publish
  cancel-in-progress: false

jobs:
  publish:
    if: github.repository_owner == 'vektopay'
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Build API Reference package
        uses: ./.github/actions/build
        with:
          packages: './packages/api-reference/**'

      - name: Prepare Docker assets
        run: |
          cp packages/api-reference/dist/browser/standalone.js integrations/docker/assets/scalar.js
          gzip --keep --verbose --force integrations/docker/assets/scalar.js

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@33fed32c1ba8775f20366ec9e8d0cd9fe8fc1dd3 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push docs image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/docker
          file: integrations/docker/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            ghcr.io/vektopay/docs:latest
            ghcr.io/vektopay/docs:${{ github.sha }}
